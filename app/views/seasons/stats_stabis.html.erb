<%
  stats = {}
  @teams.each do |team|
    stats[team.id] = {
      name: team.label_name,
      stabi: 0,
      played: 0,
      percent: 0,
      percent_sum_for_next_game: 0
    }
  end

  @schedules.map{|s| s.games}.flatten.each do |game|
    # si match joué + terrain stabi + pas de forfait
    if ['played'].include?(game.status) && game.stadium.try(:kind) == "gravel" && game.results.pluck(:forfeit).exclude?(true)
      stats[game.results.first.team_id][:stabi] += 1
      stats[game.results.last.team_id][:stabi] += 1
    end
    if ['played'].include?(game.status) &&  game.results.pluck(:forfeit).exclude?(true)
      stats[game.results.first.team_id][:played] += 1
      stats[game.results.last.team_id][:played] += 1
    end
  end
  stats.map{|k, v| v[:percent] = v[:played].zero? ? 0 : (v[:stabi]/v[:played].to_f*100).round }
  stats.each{ |team_id, data|
    games = @schedules.last.next.games
    game = games.find{|g| g.results.pluck(:team_id).include?(team_id)}
    opponent_id = game.results.where.not(team_id: team_id).first.team_id
    data[:percent_sum_for_next_game] = stats[opponent_id][:percent] + data[:percent]
  }
  stats = stats.sort_by{|k, v| [-v[:percent_sum_for_next_game], -v[:percent], v[:stabi].zero? ? v[:played]: -v[:played]] }.to_h
%>
<div class="top-page">
  <h3>
    Matches sur stabi | Saison <%= @season.years %>
  </h3>
</div>
<hr>
<table class="table table-striped table-dark table-bordered">
    <thead>
      <tr>
        <th></th>
        <th>Nb joués</th>
        <th>Nb stabi</th>
        <th class="table-active"><strong><u>% stabi</u></strong></th>
        <th>Somme % prochain adversaire</th>
      </tr>
    </thead>
    <tbody>
    <% stats.each do |team_id, data| %>
      <tr>
        <td><%= data[:name] %></td>
        <td><%= data[:played] %></td>
        <td><%= data[:stabi] %></td>
        <td class="table-active text-warning"><strong><%= data[:percent] %></strong></td>
        <td><%= data[:percent_sum_for_next_game] %></td>
      </tr>
    <% end %>

    </tbody>
    <tfoot>
      <tr class="table-secondary fst-italic">
        <td colspan="5">
        <ul>
          <li>Les matches comptabilisés exclus les reports ou forfaits.</li>
          <li><u>Somme % prochain adversaire</u>: Cumul du % de l'équipe avec celui de son prochain adversaire.</li>
        </ul>
        </td>
      </tr>
    </tfoot>
</table>
